name: CloudGuard AI — Unified CI/CD

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

# ────────────────────────────────────────────────────────────────────
jobs:
  # ─── Stage 1: Lint ────────────────────────────────────────────────
  lint:
    name: Lint (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [api, ml]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: ${{ matrix.service }}/requirements.txt

      - name: Install linters & deps
        run: |
          pip install black flake8 isort
          pip install -r ${{ matrix.service }}/requirements.txt

      - name: black
        run: black --check ${{ matrix.service }}/

      - name: flake8
        run: flake8 ${{ matrix.service }}/ --max-line-length=120 --extend-ignore=E203,W503

      - name: isort
        run: isort --check-only ${{ matrix.service }}/

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web/package-lock.json

      - run: npm ci
      - run: npm run lint

  # ─── Stage 2: Test ────────────────────────────────────────────────
  test-api:
    name: Test API
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: cloudguard_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports: ['5432:5432']
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports: ['6379:6379']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install
        run: |
          pip install pytest pytest-cov pytest-asyncio httpx asgi-lifespan
          pip install -r api/requirements.txt

      - name: Run API tests with coverage
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/cloudguard_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest api/tests/ tests/unit/ -v \
            --cov=api/app --cov=api/scanners \
            --cov-report=xml:reports/api-coverage.xml \
            --cov-report=term-missing \
            --cov-fail-under=40

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-coverage
          path: reports/api-coverage.xml

  test-ml:
    name: Test ML
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install
        run: |
          pip install pytest pytest-cov pytest-mock
          pip install -r ml/requirements.txt

      - name: Run ML tests with coverage
        run: |
          pytest ml/tests/ tests/ml/ -v \
            --cov=ml/ml_service --cov=ml/models \
            --cov-report=xml:reports/ml-coverage.xml \
            --cov-report=term-missing \
            --cov-fail-under=30

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ml-coverage
          path: reports/ml-coverage.xml

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: lint-frontend
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web/package-lock.json

      - run: npm ci
      - run: npx vitest run --reporter=verbose

  # ─── Stage 3: Build & Push ────────────────────────────────────────
  build-images:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [test-api, test-ml, test-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/Dockerfile.api
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/api:${{ github.sha }}
            ghcr.io/${{ github.repository }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push ML
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/Dockerfile.ml
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/ml:${{ github.sha }}
            ghcr.io/${{ github.repository }}/ml:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push Web
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/Dockerfile.web
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/web:${{ github.sha }}
            ghcr.io/${{ github.repository }}/web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ─── Stage 4: Helm Deploy (staging) ──────────────────────────────
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-images
    if: github.ref == 'refs/heads/main'
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Helm lint
        run: helm lint infra/helm/cloudguard

      - name: Helm template (dry-run)
        run: |
          helm template cloudguard infra/helm/cloudguard \
            --set api.image.tag=${{ github.sha }} \
            --set ml.image.tag=${{ github.sha }} \
            --set web.image.tag=${{ github.sha }}

      # Uncomment when cluster is configured:
      # - name: Deploy
      #   run: |
      #     helm upgrade --install cloudguard infra/helm/cloudguard \
      #       --namespace cloudguard --create-namespace \
      #       --set api.image.tag=${{ github.sha }} \
      #       --wait --timeout 5m
